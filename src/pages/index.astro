---
import BaseLayout from "../layouts/BaseLayout.astro";

const TITLE = "Capitoken (CAPI) — Official Website";
const DESC =
  "Capitoken official website — verified links, live-ready launch panel, tokenomics, roadmap, and community updates.";

// >>> EDITA AQUÍ cuando tengas data real <<<
const TOKEN_ADDRESS = "0xF2dA6C9B945c688A52D3B72340E622014920de6a"; // "0x..." (ETH mainnet)
const DEX_PAIR_ADDRESS = "0xb96808b1270A89eA8A237d52df389619f347AeA2"; // opcional
const X_HANDLE = "Capitoken"; // sin @ (ej: "Capitoken")
// >>> ------------------------------ <<<

const stats = [
  { label: "Chain", value: "Ethereum Mainnet" },
  { label: "Status", value: "Building" },
  { label: "Focus", value: "Community-first" },
  { label: "Symbol", value: "CAPI" },
];

const tokenomics = [
  { title: "97% Community", desc: "Broad distribution & liquidity-first mindset." },
  { title: "2% Operations", desc: "Sustains development, infra, and execution." },
  { title: "1% Marketing", desc: "Growth loops, listings, and content." },
];

const roadmap = [
  { phase: "Phase 1", title: "Foundation", items: ["Brand + Website", "Docs/Whitepaper", "Official channels live"] },
  { phase: "Phase 2", title: "Launch Prep", items: ["Final checks", "DEX readiness", "Verified links live"] },
  { phase: "Phase 3", title: "Expansion", items: ["Listings", "Ecosystem features", "Partnerships"] },
];
---

<BaseLayout title={TITLE} description={DESC}>
  <!-- HERO -->
  <section class="hero" id="launch">
    <div class="container reveal reveal--2">
      <div class="trust-row">
        <div class="trust-badge" id="trustBadgeHero">
          <span class="trust-dot" aria-hidden="true"></span>
          <span id="trustStatusHero">Checking trust…</span>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <a class="pill" href={import.meta.env.BASE_URL + "verify/"} style="text-decoration:none;">
            <span class="pill-dot" aria-hidden="true"></span>
            Verify
          </a>
          <span class="pill" id="networkPill">
            <span class="pill-dot" aria-hidden="true"></span>
            <span>Ethereum Mainnet</span>
          </span>
        </div>
      </div>

      <h1>
        Capitoken is building a <span style="color: var(--accent)">community-first</span> memecoin ecosystem.
      </h1>

      <p class="hero__lead">
        Deep-green premium design, clear narrative, and verified links — built for adoption.
        Live market data will appear automatically once the verified contract/pair is published.
      </p>

      <!-- Mini-boxes (left) + Trust bar (right) in ONE ROW -->
      <div class="hero-stats-row" aria-label="Quick status">
        <div class="hero-stats-mini">
          <div class="hero-stat">
            <div class="k">Chain</div>
            <div class="v">Ethereum Mainnet</div>
          </div>
          <div class="hero-stat">
            <div class="k">Status</div>
            <div class="v">Building</div>
          </div>
          <div class="hero-stat">
            <div class="k">Focus</div>
            <div class="v">Community-first</div>
          </div>
          <div class="hero-stat">
            <div class="k">Symbol</div>
            <div class="v">CAPI</div>
          </div>
        </div>

        <!-- Trust bar (RIGHT SIDE like your mock) -->
        <div class="hero-trustbar" data-trust="bar">
          <div class="trustbar-head">
            <div class="trustbar-label" id="trustLabelHero">Trust Score</div>
            <div class="trustbar-value">
              <span id="trustScoreHero">80</span>
              <span class="muted">/ 100</span>
            </div>
          </div>

          <div
            class="trustbar"
            id="trustBarHero"
            role="progressbar"
            aria-label="Trust Score"
            aria-valuemin="0"
            aria-valuemax="100"
            aria-valuenow="80"
          >
            <div class="trustbar__fill" id="trustBarFill" style="width: 80%"></div>
          </div>

          <div class="trustbar-hint" id="trustHintHero" hidden>
            You are viewing a mirror. The official site is <span id="trustMirrorUrl">https://www.capitoken.org</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <hr class="hr" />

  <!-- LAUNCH PANEL -->
  <section class="section" id="launchpanel">
    <div class="container reveal reveal--3">
      <div class="section-block">
      <h2 class="section-title">Launch Panel</h2>
      <p class="small">Single source of truth for contract, DEX pair, and status.</p>

      <div class="trust-badges" aria-label="Trust badges">
        <span class="badge" id="badgeContract">Contract: Pending</span>
        <span class="badge" id="badgePair">Pair: Pending</span>
        <span class="badge" id="badgeMarket">Market: Pending</span>
      </div>

      <div class="launch-grid">
        <div class="launch-row">
          <!-- Contract -->
          <div class="card">
            <div class="card__title">Contract</div>

            <div class="card__body">
              <div class="addr-row">
                <span class="mono addr" id="contractShort">TBA — verify only here</span>
                <div class="addr-actions">
                  <button class="btn btn--mini btn--primary" id="copyContractBtn" type="button">Copy</button>
                  <a class="btn btn--mini" id="verifyContractBtn" href="#" target="_blank" rel="noreferrer noopener">Etherscan</a>
                </div>
              </div>

              <details class="addr-details" id="contractDetails" style="display:none;">
                <summary>Show full address</summary>
                <div class="mono" id="contractFull"></div>
              </details>

              <div id="accountPill" class="pill" style="margin-top:12px; display:none;">
                <span class="pill-dot"></span>
                <span class="mono" id="acct">—</span>
              </div>

              <p class="small note" style="margin-top:12px;">
                Read-only verification. No approvals. Never sign "verify" prompts. If it’s not listed on this site, assume it’s not official.
              </p>
            </div>

            <div class="card__footer">
              <div class="small">Wallet tools</div>
              <div class="actions" style="margin-top:10px;">
                <button class="btn" id="connectWalletBtn" type="button">Connect Wallet</button>
                <button class="btn" id="watchTokenBtn" type="button">Add to MetaMask</button>
              </div>
            </div>
          </div>

          <!-- DEX Pair -->
          <div class="card">
            <div class="card__title">DEX Pair</div>

            <div class="card__body">
              <div class="addr-row">
                <span class="mono addr" id="pairShort">TBA</span>
                <div class="addr-actions">
                  <button class="btn btn--mini btn--primary" id="copyPairBtn" type="button">Copy</button>
                  <a class="btn btn--mini" id="verifyPairBtn" href="#" target="_blank" rel="noreferrer noopener">Etherscan</a>
                </div>
              </div>

              <details class="addr-details" id="pairDetails" style="display:none;">
                <summary>Show full pair</summary>
                <div class="mono" id="pairFull"></div>
              </details>

              <p class="small note" style="margin-top:12px;">
                Only use official swap links from this panel. Scammers often publish fake pairs.
              </p>
            </div>

            <div class="card__footer">
              <div class="actions">
                <a class="btn btn--primary" id="buyOnUniswap" href="#" target="_blank" rel="noreferrer noopener nofollow">Buy $CAPI</a>
                <a class="btn" id="openDexScreener" href="#" target="_blank" rel="noreferrer noopener">Live Market</a>
              </div>

              <div class="small" style="margin-top:10px;">Quick Uniswap routes</div>
              <div class="actions" style="margin-top:10px;">
                <a class="btn route-btn" id="dexWethToCapi" href="#" rel="nofollow noopener">WETH → CAPI</a>
                <a class="btn route-btn" id="dexCapiToWeth" href="#" rel="nofollow noopener">CAPI → WETH</a>
              </div>
            </div>
          </div>
        </div>

        <div class="launch-row">
          <!-- CAPI Pulse (Live) -->
          <div class="card">
            <div class="card__title">CAPI Pulse (Live)</div>
            <div class="small">Simple live stats via DexScreener. If blocked by extensions, you’ll see placeholders.</div>

            <div class="pill" style="margin-top:10px;">
              <span class="pill-dot"></span>
              <span id="pulseNetwork">Ethereum Mainnet</span>
            </div>

            <div class="stats" style="margin-top:14px;">
              <div class="stat"><div class="k">Price</div><div class="v" id="mPrice">TBA</div></div>
              <div class="stat"><div class="k">Market Cap (est.)</div><div class="v" id="mMcap">TBA</div></div>
              <div class="stat"><div class="k">Liquidity</div><div class="v" id="mLiq">TBA</div></div>
              <div class="stat"><div class="k">24h Volume</div><div class="v" id="mVol">TBA</div></div>
              <div class="stat"><div class="k">24h Buys / Sells</div><div class="v" id="pulseBS">—</div></div>
              <div class="stat"><div class="k">Pair age</div><div class="v" id="pulseAge">—</div></div>
            </div>

            <p class="small" style="margin-top:12px;">
              If it’s not listed here, it’s not official. Always cross-check the URL.
            </p>
          </div>

          <!-- Wallet Hangar -->
          <div class="card">
            <div class="card__title">Wallet Hangar</div>
            <div class="small">Pick your wallet. (Connecting is optional; Launch Panel stays read-only by default.)</div>

            <div class="venue-grid" id="walletGrid" aria-live="polite" style="margin-top:12px;"></div>

            <div class="small" style="margin-top:10px; opacity:.85;">
              Tip: For maximum safety, verify contract on <b>/verify</b> before importing tokens into any wallet.
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </section>

  <!-- PHASE 9 – Trading Venues (DEX / CEX) -->
  <section class="section" id="venues">
    <div class="container reveal">
      <div class="section-block">
      <div class="section__head">
        <h2 class="section-title">Trading Venues</h2>
        <p class="small">
          Only use official links. If a venue is not listed here, assume it is not official.
        </p>
      </div>

      <div class="venues">
        <div class="venue-block">
          <div class="venue-title">DEX Enabled</div>
          <div class="venue-grid" id="dexGrid" aria-live="polite"></div>
          <div class="small venue-hint">Live once the verified pair is published.</div>
        </div>

        <div class="venue-block">
          <div class="venue-title">CEX Listings</div>
          <div class="venue-grid" id="cexGrid" aria-live="polite"></div>
          <div class="small venue-hint">CEX links will appear here once official listings go live.</div>
        </div>
      </div>
      </div>
    </div>
  </section>

  <script type="module">
    // Phase 9: Trading venues data (editable via /public/venues.json)
    const makeEl = (tag, attrs = {}, children = []) => {
      const el = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (k === "class") el.className = v;
        else if (k === "html") el.innerHTML = v;
        else if (v !== undefined) el.setAttribute(k, String(v));
      }
      for (const c of children) el.append(c);
      return el;
    };

    const safeUrl = (u) => {
      try { return new URL(u).toString(); } catch { return ""; }
    };

    // Fallback local (si /public/venues.json no está disponible)
    // Nota: La lista exacta por “top volumen” cambia día a día.
    // Aquí dejamos una selección estable de venues grandes y reconocibles.
    const fallback = {
      dex: [
        { name: "Uniswap", url: "https://app.uniswap.org/", iconDomain: "uniswap.org", enabled: true, note: "Enabled" },
        { name: "PancakeSwap", url: "https://pancakeswap.finance/swap", iconDomain: "pancakeswap.finance", enabled: false, note: "Pending" },
        { name: "Curve", url: "https://curve.fi/", iconDomain: "curve.fi", enabled: false, note: "Pending" },
        { name: "Raydium", url: "https://raydium.io/swap/", iconDomain: "raydium.io", enabled: false, note: "Pending" },
        { name: "Orca", url: "https://www.orca.so/", iconDomain: "orca.so", enabled: false, note: "Pending" },
        { name: "Aerodrome", url: "https://aerodrome.finance/swap", iconDomain: "aerodrome.finance", enabled: false, note: "Pending" },
        { name: "SushiSwap", url: "https://www.sushi.com/swap", iconDomain: "sushi.com", enabled: false, note: "Pending" },
        { name: "1inch", url: "https://app.1inch.io/", iconDomain: "1inch.io", enabled: false, note: "Pending" }
      ],
      cex: [
        // Binance: icono explícito (favicon oficial). Si falla, cae al fallback (iniciales).
        { name: "Binance", url: "https://www.binance.com/", icon: "https://www.binance.com/favicon.ico", iconDomain: "binance.com", enabled: false, note: "Coming soon" },
        { name: "Coinbase", url: "https://www.coinbase.com/", iconDomain: "coinbase.com", enabled: false, note: "Coming soon" },
        { name: "Upbit", url: "https://upbit.com/", iconDomain: "upbit.com", enabled: false, note: "Coming soon" },
        { name: "OKX", url: "https://www.okx.com/", iconDomain: "okx.com", enabled: false, note: "Coming soon" },
        { name: "Bybit", url: "https://www.bybit.com/", iconDomain: "bybit.com", enabled: false, note: "Coming soon" },
        { name: "Bitget", url: "https://www.bitget.com/", iconDomain: "bitget.com", enabled: false, note: "Coming soon" },
        { name: "Gate", url: "https://www.gate.io/", iconDomain: "gate.io", enabled: false, note: "Coming soon" },
        { name: "KuCoin", url: "https://www.kucoin.com/", iconDomain: "kucoin.com", enabled: false, note: "Coming soon" }
      ]
    };

    async function loadVenues(){
      const url = new URL("venues.json", window.location.href).toString();
      try{
        const r = await fetch(url, { cache: "no-store" });
        if(!r.ok) throw new Error("venues fetch failed");
        const data = await r.json();
        if(!data || (!Array.isArray(data.dex) && !Array.isArray(data.cex))) throw new Error("venues shape invalid");
        return { dex: Array.isArray(data.dex)? data.dex : [], cex: Array.isArray(data.cex)? data.cex : [] };
      }catch{
        return fallback;
      }
    }

    function makeIconFallback(name){
      const s = (name || "?").trim();
      const parts = s.split(/\s+/).filter(Boolean);
      const a = (parts[0] || "?").slice(0, 1);
      const b = (parts[1] || "").slice(0, 1);
      return (a + b).toUpperCase();
    }

    // External icon strategy (Option B): multi-source cascade.
    // Goal: never break layout; if all sources fail -> initials fallback.
    // Sources (in order): explicit icon URL -> icon.horse -> clearbit -> Google S2.
    // Some venues (Binance / 1inch) may return generic icons from favicon services.
    // We force a first-choice icon from a CDN that tends to be more stable.
    function forcedIcon(it){
      const n = (it && it.name) ? String(it.name).toLowerCase() : "";
      // Simple Icons via jsDelivr (stable CDN). These are monochrome but reliable.
      if(n === "binance"){
        return "https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/binance.svg";
      }
      if(n === "1inch" || n.includes("1inch")){
        // Simple-icons uses the slug "1inch".
        return "https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/1inch.svg";
      }
      return "";
    }
    function iconCandidates(it){
      const out = [];
      const forced = forcedIcon(it);
      if(forced) out.push(forced);
      if(it && it.icon) out.push(String(it.icon));
      const d = (it && it.iconDomain) ? String(it.iconDomain).trim() : "";
      if(d){
        out.push(`https://icon.horse/icon/${encodeURIComponent(d)}?size=64`);
        out.push(`https://logo.clearbit.com/${encodeURIComponent(d)}?size=64`);
        out.push(`https://www.google.com/s2/favicons?domain=${encodeURIComponent(d)}&sz=64`);
      }
      // De-dup while preserving order
      return out.filter((u, i) => u && out.indexOf(u) === i);
    }

    function renderGrid(targetId, items){
      const host = document.getElementById(targetId);
      if(!host) return;

      host.innerHTML = "";
      items.forEach((it) => {
        const href = safeUrl(it.url);
        const enabled = Boolean(it.enabled) && href;
        const a = makeEl(enabled ? "a" : "div", {
          class: "venue-tile" + (enabled ? "" : " is-disabled"),
          href: enabled ? href : undefined,
          target: enabled ? "_blank" : undefined,
          rel: enabled ? "noreferrer noopener" : undefined
        });

        // Icon: evitamos que el texto del alt se renderice cuando el icono falla.
        // Accesibilidad: ponemos el nombre en aria-label del tile.
        a.setAttribute("aria-label", it.name || "Venue");

        const iconWrap = makeEl("div", { class: "venue-iconwrap" });

        const img = makeEl("img", {
          class: "venue-icon",
          alt: "", // <- clave para evitar texto superpuesto si falla
          loading: "lazy",
          referrerpolicy: "no-referrer"
        });

        const addFallback = () => {
          if(iconWrap.querySelector(".venue-icon-fallback")) return;
          const fb = makeEl("div", { class: "venue-icon-fallback", html: makeIconFallback(it.name) });
          iconWrap.append(fb);
        };

        const candidates = iconCandidates(it);

        const setNext = () => {
          const next = candidates.shift();
          if(!next){
            try { img.remove(); } catch {}
            addFallback();
            return;
          }
          // Simple-icons SVGs are monochrome; make them visible on dark glass UI.
          if(next.includes("cdn.jsdelivr.net/npm/simple-icons")){
            img.classList.add("is-mono");
          }else{
            img.classList.remove("is-mono");
          }
          img.setAttribute("src", next);
        };

        if(!candidates.length){
          addFallback();
        }else{
          img.addEventListener("error", () => {
            // Try next external source. If all fail, fallback initials.
            setNext();
          });
          // Start with best candidate.
          setNext();
          iconWrap.append(img);
        }

        const name = makeEl("div", { class: "venue-name", html: (it.name || "Venue") });
        const note = makeEl("div", { class: "venue-note small", html: (it.note || (enabled ? "Enabled" : "Pending")) });

        a.append(iconWrap, makeEl("div", { class: "venue-meta" }, [name, note]));
        host.append(a);
      });

      if(!items.length){
        host.append(makeEl("div", { class: "small", html: "No venues published yet." }));
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const data = await loadVenues();
      renderGrid("dexGrid", data.dex);
      renderGrid("cexGrid", data.cex);
    });
  </script>

  <hr class="hr" />

  <!-- TOKENOMICS -->
  <section class="section" id="tokenomics">
    <div class="container reveal">
      <div class="section-block">
      <h2>Tokenomics</h2>
      <p>Simple allocation — 97 / 2 / 1.</p>

      <div class="grid" style="margin-top:14px;">
        {tokenomics.map((t) => (
          <div class="card col-6">
            <h3>{t.title}</h3>
            <p>{t.desc}</p>
            <div style="margin-top:12px; height:4px; width:72px; border-radius:999px; background: rgba(248,168,64,0.55);"></div>
          </div>
        ))}
        <div class="card col-12">
          <div class="kv"><strong>Community</strong><span>97%</span></div>
          <div class="kv"><strong>Operations</strong><span>2%</span></div>
          <div class="kv"><strong>Marketing</strong><span>1%</span></div>
        </div>
      </div>
      </div>
    </div>
  </section>

  <hr class="hr" />

  <!-- ROADMAP -->
  <section class="section" id="roadmap">
    <div class="container reveal">
      <div class="section-block">
      <h2>Roadmap</h2>
      <p>Focused phases with clear deliverables.</p>

      <div class="grid" style="margin-top:14px;">
        {roadmap.map((r) => (
          <div class="card col-6">
            <div class="small">{r.phase}</div>
            <div style="margin-top:6px; font-weight:900; font-size:18px;">{r.title}</div>
            <ul style="margin:12px 0 0 0; padding-left: 18px; color: var(--muted);">
              {r.items.map((i) => <li style="margin: 6px 0;">{i}</li>)}
            </ul>
          </div>
        ))}
      </div>
      </div>
    </div>
  </section>

  <hr class="hr" />

  <!-- DAILY CAPI / NARRATIVE -->
  <section class="section" id="daily">
    <div class="container reveal">
      <div class="section-block">
      <h2>Daily Capi</h2>
      <p>
        Short daily thoughts we can recycle to X/Twitter, plus community prompts. (We can later convert this into a real blog.)
      </p>

      <div class="grid" style="margin-top:14px;">
        <div class="card col-6">
          <h3>Today’s prompt</h3>
          <p class="small">What should the community prioritize next: memes, utility, listings, or partnerships?</p>
          <a class="btn btn--primary" href={`https://twitter.com/${X_HANDLE}`} target="_blank" rel="noreferrer">Reply on X</a>
        </div>
        <div class="card col-6">
          <h3>Build in public</h3>
          <p class="small">We publish verified updates here first, then mirror them to socials. Bookmark this page.</p>
          <a class="btn" href="#launchpanel">Back to Launch Panel</a>
        </div>
      </div>
      </div>
    </div>
  </section>

  <hr class="hr" />

  <!-- COMMUNITY -->
  <section class="section" id="community">
    <div class="container reveal">
      <div class="section-block">
      <h2>Community</h2>
      <p>
        Live social embeds + feedback loop. Next step: add Discord/Telegram widgets once your official URLs are final.
      </p>

      <div class="grid" style="margin-top:14px;">
        <div class="card col-12">
          <h3>Official X feed</h3>
          <p class="small">If this embed is blank, your browser/extensions may block it. The link still works.</p>

          <a class="btn btn--primary" href={`https://twitter.com/${X_HANDLE}`} target="_blank" rel="noreferrer">
            Open X profile
          </a>

          <div style="margin-top:14px;">
            <a class="twitter-timeline"
               data-theme="dark"
               data-tweet-limit="3"
               href={`https://twitter.com/${X_HANDLE}`}>
               Tweets by {X_HANDLE}
            </a>
          </div>
        </div>
      </div>
      </div>
    </div>
  </section>

  <hr class="hr" />

  <!-- FAQ -->
  <section class="section" id="faq">
    <div class="container reveal">
      <div class="section-block">
      <h2>FAQ</h2>

      <div class="grid" style="margin-top:14px;">
        <div class="card col-6">
          <h3>Where is the official contract?</h3>
          <p class="small">We publish the verified contract address in the Launch Panel and Official Links.</p>
        </div>

        <div class="card col-6">
          <h3>Is this financial advice?</h3>
          <p class="small">No. Crypto is high risk. Always do your own research.</p>
        </div>

        <div class="card col-6">
          <h3>Why verify only here?</h3>
          <p class="small">Scammers frequently clone brands. This site is the single source of truth for official links.</p>
        </div>

        <div class="card col-6">
          <h3>When live market data?</h3>
          <p class="small">As soon as the verified contract/pair is published, live metrics auto-populate.</p>
        </div>
      </div>
      </div>
    </div>
  </section>

  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite" style="position:fixed;left:16px;bottom:16px;opacity:0;transform:translateY(8px);transition:all .2s;pointer-events:none;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.15);padding:10px 12px;border-radius:12px;font-size:.95rem;"></div>

  <!-- X widget loader -->
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

  <!-- Live + Wallet script -->
  <script is:inline type="module" define:vars={{ TOKEN_ADDRESS, DEX_PAIR_ADDRESS }}>
    const ENGINE_V = new URL(window.location.href).searchParams.get("v") || "PHASE9PULSE_R1";

    const $id = (id) => document.getElementById(id);

    let explorerBase = "https://etherscan.io";
    let networkName = "Ethereum Mainnet";
    let tokenAddr = TOKEN_ADDRESS || "";
    let pairAddr = DEX_PAIR_ADDRESS || "";
    let tokenMeta = { symbol: "CAPI", decimals: 18, image: "" };

    const toast = (msg) => {
      const el = $id("toast");
      if(!el) return;
      el.textContent = msg;
      el.style.opacity = "1";
      el.style.transform = "translateY(0)";
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=>{
        el.style.opacity = "0";
        el.style.transform = "translateY(8px)";
      }, 1800);
    };

    async function copyText(val){
      if(!val) return;
      try{
        await navigator.clipboard.writeText(val);
        toast("Copied");
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = val;
        ta.setAttribute("readonly","");
        ta.style.position="absolute";
        ta.style.left="-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Copied");
      }
    }

    function short(a){
      if(!a) return "";
      return a.slice(0,6)+"…"+a.slice(-4);
    }

    function fmtUSD(n, d=2){
      if(n === null || n === undefined || Number.isNaN(Number(n))) return "TBA";
      return Number(n).toLocaleString(undefined, { style:"currency", currency:"USD", maximumFractionDigits:d });
    }

    function setTxt(id, v){
      const el = $id(id);
      if(el) el.textContent = v;
    }
    function setWidth(id, pct){
      const el = $id(id);
      if(el) el.style.width = `${Math.max(0, Math.min(100, Number(pct)||0))}%`;
    }

    async function loadRegistry(){
      try{
        const url = new URL("official-registry.json", window.location.href).toString() + `?v=${ENGINE_V}`;
        const r = await fetch(url, { cache:"no-store" });
        if(!r.ok) throw new Error("registry fetch failed");
        return await r.json();
      }catch{
        return null;
      }
    }

    function scoreFrom(reg, isOfficialHost){
      let s = 60;
      if(isOfficialHost) s += 20;
      if(reg?.contract?.verified) s += 10;
      if(reg?.pair?.address) s += 5;
      if(reg?.links && Object.keys(reg.links).length) s += 5;
      return Math.max(0, Math.min(100, s));
    }

    async function initTrustHero(){
      const data = await loadRegistry();

      explorerBase = String(data?.network?.explorer || explorerBase);
      networkName = String(data?.network?.name || networkName);
      tokenAddr = String(data?.contract?.address || tokenAddr || "");
      pairAddr = String((data?.pair?.address) || pairAddr || "");
      tokenMeta = {
        symbol: String(data?.contract?.token?.symbol || tokenMeta.symbol || "CAPI"),
        decimals: Number(data?.contract?.token?.decimals ?? tokenMeta.decimals ?? 18),
        image: String(data?.links?.tokenImage || tokenMeta.image || "")
      };

      const host = window.location.hostname;
      const allowed = new Set((data?.allowedDomains || []).map((x) => String(x).toLowerCase()));
      const isOfficialHost = allowed.size ? allowed.has(String(host).toLowerCase()) : true;

      const score = scoreFrom(data, isOfficialHost);
      setTxt("trustScoreHero", String(score));
      setWidth("trustBarFill", score);

      const pb = $id("trustBarHero");
      if (pb) pb.setAttribute("aria-valuenow", String(score));

      const status = isOfficialHost ? "VERIFIED OFFICIAL DOMAIN" : "MIRROR DOMAIN — VERIFY NOW";
      setTxt("trustStatusHero", status);

      const hintEl = $id("trustHintHero");
      const mirrorEl = $id("trustMirrorUrl");

      if(!isOfficialHost){
        const hint = data?.security?.mirrorNotice || "You are viewing a mirror. Verify on the official domain.";
        if(hintEl){
          hintEl.hidden = false;
          hintEl.textContent = hint;
        }
        if(mirrorEl && data?.security?.officialUrl) mirrorEl.textContent = String(data.security.officialUrl);
      }else{
        if(hintEl) hintEl.hidden = true;
      }

      const badge = $id("trustBadgeHero");
      if (badge) {
        badge.classList.remove("is-verified", "is-warn");
        badge.classList.add(isOfficialHost ? "is-verified" : "is-warn");
      }

      const netPill = $id("networkPill");
      if (netPill) {
        const spans = netPill.querySelectorAll("span");
        if (spans.length) spans[spans.length - 1].textContent = networkName;
      }
      setTxt("pulseNetwork", networkName);
    }

    function setBadge(id, label){
      const el = $id(id);
      if(el) el.textContent = label;
    }

    function setLaunchTexts(){
      if(tokenAddr){
        setBadge("badgeContract", "Contract: Live");
        setTxt("contractShort", short(tokenAddr));
        setTxt("contractFull", tokenAddr);
        $id("contractDetails")?.style?.setProperty("display","block");
        const v = $id("verifyContractBtn");
        if(v) v.href = `${explorerBase}/token/${tokenAddr}`;
      }else{
        setBadge("badgeContract", "Contract: Pending");
      }

      if(pairAddr){
        setBadge("badgePair", "Pair: Live");
        setTxt("pairShort", short(pairAddr));
        setTxt("pairFull", pairAddr);
        $id("pairDetails")?.style?.setProperty("display","block");
        const v = $id("verifyPairBtn");
        if(v) v.href = `${explorerBase}/address/${pairAddr}`;
      }else{
        setBadge("badgePair", "Pair: Pending");
      }
    }

    function setDexLinks(){
      const weth = "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2";
      if(tokenAddr){
        const buy = `https://app.uniswap.org/#/swap?inputCurrency=${weth}&outputCurrency=${tokenAddr}`;
        const sell = `https://app.uniswap.org/#/swap?inputCurrency=${tokenAddr}&outputCurrency=${weth}`;
        const dex = pairAddr ? `https://dexscreener.com/ethereum/${pairAddr}` : `https://dexscreener.com/ethereum/${tokenAddr}`;

        const aBuy = $id("buyOnUniswap"); if(aBuy) aBuy.href = buy;
        const aDex = $id("openDexScreener"); if(aDex) aDex.href = dex;

        const r1 = $id("dexWethToCapi"); if(r1) r1.href = buy;
        const r2 = $id("dexCapiToWeth"); if(r2) r2.href = sell;
      }
    }

    async function connectInjected(){
      try{
        if(!window.ethereum) { toast("No injected wallet detected"); return; }
        const accounts = await window.ethereum.request({ method:"eth_requestAccounts" });
        const a = accounts?.[0];
        if(!a) return;
        const pill = $id("accountPill");
        if(pill) pill.style.display = "inline-flex";
        setTxt("acct", short(a));
      }catch(e){
        console.warn("connectInjected failed", e);
      }
    }

    async function watchToken(){
      try{
        if(!window.ethereum || !tokenAddr) return;
        await window.ethereum.request({
          method: "wallet_watchAsset",
          params: {
            type: "ERC20",
            options: {
              address: tokenAddr,
              symbol: tokenMeta?.symbol || "CAPI",
              decimals: Number(tokenMeta?.decimals ?? 18),
              image: tokenMeta?.image || undefined
            }
          }
        });
        toast("Token added (if supported)");
      }catch(e){
        console.warn("watchToken failed", e);
        toast("Wallet declined / not supported");
      }
    }

    function setMarketBadge(txt){
      setBadge("badgeMarket", txt);
    }

    function humanAge(ts){
      if(!ts) return "—";
      const t = Number(ts);
      if(!Number.isFinite(t)) return "—";
      const diff = Date.now() - t;
      const mins = Math.max(0, Math.floor(diff/60000));
      if(mins < 60) return `${mins}m`;
      const hrs = Math.floor(mins/60);
      if(hrs < 48) return `${hrs}h`;
      const days = Math.floor(hrs/24);
      return `${days}d`;
    }

    async function loadDexScreener(){
      if(!tokenAddr && !pairAddr) return;

      try{
        const url = pairAddr
          ? `https://api.dexscreener.com/latest/dex/pairs/ethereum/${pairAddr}`
          : `https://api.dexscreener.com/latest/dex/tokens/${tokenAddr}`;

        const r = await fetch(url, { cache:"no-store" });
        if(!r.ok) throw new Error("dexscreener fetch failed");

        const j = await r.json();
        const p = (j?.pairs && j.pairs[0]) ? j.pairs[0] : null;
        if(!p){ setMarketBadge("Market: Indexing"); return; }

        setMarketBadge("Market: Live");

        $id("mPrice").textContent = fmtUSD(p.priceUsd, 8);
        $id("mLiq").textContent = fmtUSD(p?.liquidity?.usd, 0);
        $id("mVol").textContent = fmtUSD(p?.volume?.h24, 0);

        const mc = p?.marketCap ?? p?.fdv ?? null;
        $id("mMcap").textContent = mc ? fmtUSD(mc, 0) : "TBA";

        const buys = p?.txns?.h24?.buys ?? null;
        const sells = p?.txns?.h24?.sells ?? null;
        setTxt("pulseBS", (Number.isFinite(buys) && Number.isFinite(sells)) ? `${buys} / ${sells}` : "—");

        const created = p?.pairCreatedAt ?? null;
        setTxt("pulseAge", created ? humanAge(created) : "—");
      }catch(e){
        setMarketBadge("Market: Blocked");
        console.warn("DexScreener fetch failed", e);
      }
    }

    function renderWalletHangar(){
      const host = $id("walletGrid");
      if(!host) return;

      const wallets = [
        // Nota: usamos el servicio de favicons de Google por dominio para evitar "alt text" superpuesto cuando un favicon falla.
        // Si igual falla, mostramos un fallback con iniciales.
        { name:"MetaMask", url:"https://metamask.io/", iconDomain:"metamask.io", note:"Browser / Mobile" },
        { name:"Trust Wallet", url:"https://trustwallet.com/", iconDomain:"trustwallet.com", note:"Mobile" },
        { name:"Coinbase Wallet", url:"https://www.coinbase.com/wallet", iconDomain:"coinbase.com", note:"Mobile / Browser" },
        { name:"Rainbow", url:"https://rainbow.me/", iconDomain:"rainbow.me", note:"Mobile" },
        { name:"Rabby", url:"https://rabby.io/", iconDomain:"rabby.io", note:"Browser" },
        { name:"Phantom", url:"https://phantom.app/", iconDomain:"phantom.app", note:"Multi-chain" },
        { name:"WalletConnect", url:"https://walletconnect.com/", iconDomain:"walletconnect.com", note:"Connector" },
        { name:"Safe", url:"https://safe.global/", iconDomain:"safe.global", note:"Multisig" },
      ];

      host.innerHTML = "";
      wallets.forEach((it) => {
        const href = (()=>{ try { return new URL(it.url).toString(); } catch { return ""; } })();
        const a = document.createElement("a");
        a.className = "venue-tile";
        a.href = href;
        a.target = "_blank";
        a.rel = "noreferrer noopener";

        // Accesibilidad: el nombre vive en el aria-label del tile.
        a.setAttribute("aria-label", it.name || "Wallet");

        const iconWrap = document.createElement("div");
        iconWrap.className = "venue-iconwrap";

        const addFallback = () => {
          if(iconWrap.querySelector(".venue-icon-fallback")) return;
          const fb = document.createElement("div");
          fb.className = "venue-icon-fallback";
          fb.textContent = makeIconFallback(it.name);
          iconWrap.append(fb);
        };

        const iconSrc = it.icon || (it.iconDomain ? `https://www.google.com/s2/favicons?domain=${encodeURIComponent(it.iconDomain)}&sz=64` : "");

        if(iconSrc){
          const img = document.createElement("img");
          img.className = "venue-icon";
          img.alt = ""; // <- evita texto superpuesto si falla el icono
          img.loading = "lazy";
          img.referrerPolicy = "no-referrer";
          img.addEventListener("error", () => {
            try { img.remove(); } catch {}
            addFallback();
          }, { once: true });
          img.src = iconSrc;
          iconWrap.append(img);
        }else{
          addFallback();
        }

        const meta = document.createElement("div");
        meta.className = "venue-meta";

        const n = document.createElement("div");
        n.className = "venue-name";
        n.textContent = it.name;

        const note = document.createElement("div");
        note.className = "venue-note small";
        note.textContent = it.note || "";

        meta.append(n, note);
        a.append(iconWrap, meta);
        host.append(a);
      });
    }

    function syncNetworkLabels(){
      setTxt("pulseNetwork", networkName);
      document.querySelectorAll('#launchpanel .pill').forEach((pill) => {
        const spans = pill.querySelectorAll('span');
        if (spans.length) {
          const last = spans[spans.length-1];
          if (last && /ethereum/i.test(last.textContent || '')) last.textContent = networkName;
        }
      });
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      await initTrustHero();
      setLaunchTexts();
      setDexLinks();
      syncNetworkLabels();
      renderWalletHangar();

      $id("copyContractBtn")?.addEventListener("click", ()=> copyText(tokenAddr));
      $id("copyPairBtn")?.addEventListener("click", ()=> copyText(pairAddr));

      $id("connectWalletBtn")?.addEventListener("click", connectInjected);
      $id("watchTokenBtn")?.addEventListener("click", watchToken);

      await loadDexScreener();
      setInterval(loadDexScreener, 45000);
    });
  </script>

  <script is:inline>
    (function(){
      try{
        var url = new URL("build.json", window.location.href).toString();
        fetch(url, { cache: "no-store" }).then(function(r){ return r.ok ? r.json() : null; }).then(function(d){
          if(!d || !d.buildId) return;
          var key = "capitoken_build_id";
          var prev = localStorage.getItem(key);
          if(prev && prev !== d.buildId){
            localStorage.setItem(key, d.buildId);
            location.reload();
            return;
          }
          if(!prev) localStorage.setItem(key, d.buildId);
        }).catch(function(){});
      }catch(e){}
    })();
  </script>
</BaseLayout>
