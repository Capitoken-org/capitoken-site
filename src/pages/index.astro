---
import BaseLayout from "../layouts/BaseLayout.astro";

const BASE = import.meta.env.BASE_URL || "/";
const withBase = (p) => {
  const clean = String(p || "");
  return clean.startsWith("/") ? `${BASE}${clean.slice(1)}` : `${BASE}${clean}`;
};


const TITLE = "Capitoken (CAPI) ‚Äî Official Website";
const DESC =
  "Capitoken official website ‚Äî verified links, live-ready launch panel, tokenomics, roadmap, and community updates.";

// >>> EDITA AQU√ç cuando tengas data real <<<
const TOKEN_ADDRESS = "0xF2dA6C9B945c688A52D3B72340E622014920de6a"; // "0x..." (ETH mainnet)
const DEX_PAIR_ADDRESS = "0xb96808b1270A89eA8A237d52df389619f347AeA2"; // opcional
const X_HANDLE = "Capitokenorg"; // sin @ (ej: "Capitokenorg")
const YT_CHANNEL_ID = "UCY5xCVzo-k6hGdR4xhUhTNQ"; // YouTube Channel ID
const YT_HANDLE = "CapiToken"; // sin @ (ej: "CapiToken")
const YT_VIDEO_ID = ""; // Video fijo (ej: "dQw4w9WgXcQ") ‚Äî deja vac√≠o para mostrar solo bot√≥n al canal
// >>> ------------------------------ <<<

const stats = [
  { label: "Chain", value: "Ethereum Mainnet" },
  { label: "Status", value: "Building" },
  { label: "Focus", value: "Community-first" },
  { label: "Symbol", value: "CAPI" },
];

const tokenomics = [
  { title: "97% Community", desc: "Broad distribution & liquidity-first mindset." },
  { title: "2% Operations", desc: "Sustains development, infra, and execution." },
  { title: "1% Marketing", desc: "Growth loops, listings, and content." },
];

const roadmap = [
  {
    id: "phase-1",
    phase: "Phase 1",
    title: "Foundation",
    status: "ACTIVE",
    objective: "Build trust, clarity, and a single source of truth.",
    items: [{ t: "Brand & Identity", d: "Unify visuals, voice, and trust signals across web & socials." }, { t: "Website & Documentation", d: "Keep one source of truth for contract links, guides, and updates." }, { t: "On-Chain Transparency", d: "Clear links to verified contract, LP, and key on-chain metrics." }],
  },
  {
    id: "phase-2",
    phase: "Phase 2",
    title: "Launch Prep",
    status: "COMPLETED",
    objective: "Engineer a clean, fair, and controlled market entry.",
    items: [{ t: "Launch Engineering", d: "Clean launch flow, verified links, and controlled communication." }, { t: "Temporary Anti-Bot & Anti-Whale", d: "Short-term protections to reduce sniping and early manipulation." }, { t: "Verification Ready", d: "Everything prepared for explorers, listings, and trust dashboards." }],
  },
  {
    id: "phase-3",
    phase: "Phase 3",
    title: "Expansion",
    status: "IN-PROGRESS",
    objective: "Grow distribution, visibility, and ecosystem trust.",
    items: [{ t: "Listings & Indexation", d: "Expand visibility through verified listings and ecosystem indexation." }, { t: "Ecosystem Integrations", d: "Connect with tools, dashboards, and community-friendly utilities." }, { t: "Community Growth", d: "Sustainable distribution through content, events, and collaborations." }],
  },
  {
    id: "phase-4",
    phase: "Phase 4",
    title: "Future Horizon",
    status: "COMMUNITY-LED",
    objective: "Enable real-world relevance and long-term adoption.",
    items: [{ t: "CAPI PASS (NFT Membership)", d: "Optional membership layer for perks and community identity." }, { t: "CAPI IRL Toolkit", d: "Templates & assets for real‚Äëworld meetups and partnerships." }, { t: "CAPI Arena", d: "Community games, tournaments, and badge-style achievements." }, { t: "Proof-of-Good", d: "Impact & transparency initiatives driven by the community." }],
  },
];

---

<BaseLayout title={TITLE} description={DESC}>
  <!-- HERO -->
  <section class="hero" id="launch">
    <div class="container reveal reveal--2">
      <div class="trust-row">
        <div class="trust-badge" id="trustBadgeHero">
          <span class="trust-dot" aria-hidden="true"></span>
          <span id="trustStatusHero">Checking trust‚Ä¶</span>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <a class="pill" href={import.meta.env.BASE_URL + "verify/"} style="text-decoration:none;">
            <span class="pill-dot" aria-hidden="true"></span>
            Verify
          </a>
          <span class="pill" id="networkPill">
            <span class="pill-dot" aria-hidden="true"></span>
            <span>Ethereum Mainnet</span>
          </span>
        </div>
      </div>

      <h1>
        A memecoin ecosystem built on trust ‚Äî <span style="color: var(--accent)">proof over promises</span>.
      </h1>

      <p class="hero__lead">
        Transparent tokenomics, verified contracts and links, and a single source of truth.
        If it‚Äôs not verified here, it‚Äôs not CAPI.
      </p>

      <!-- Mini-boxes (left) + Trust bar (right) in ONE ROW -->
      <div class="hero-stats-row" aria-label="Quick status">
        <div class="hero-stats-mini">
          <div class="hero-stat">
            <div class="k">Chain</div>
            <div class="v">Ethereum Mainnet</div>
          </div>
          <div class="hero-stat">
            <div class="k">Status</div>
            <div class="v">Building</div>
          </div>
          <div class="hero-stat">
            <div class="k">Focus</div>
            <div class="v">Community-first</div>
          </div>
          <div class="hero-stat">
            <div class="k">Symbol</div>
            <div class="v">CAPI</div>
          </div>
        </div>

        <!-- Trust bar (RIGHT SIDE like your mock) -->
        <div class="hero-trustbar" data-trust="bar">
          <div class="trustbar-head">
            <div class="trustbar-label" id="trustLabelHero">Trust Score</div>
            <div class="trustbar-value">
              <span id="trustScoreHero">80</span>
              <span class="muted">/ 100</span>
            </div>
          </div>

          <div
            class="trustbar"
            id="trustBarHero"
            role="progressbar"
            aria-label="Trust Score"
            aria-valuemin="0"
            aria-valuemax="100"
            aria-valuenow="80"
          >
            <div class="trustbar__fill" id="trustBarFill" style="width: 80%"></div>
          </div>

          <div class="trustbar-hint" id="trustHintHero" hidden>
            You are viewing a mirror. The official site is <span id="trustMirrorUrl">https://www.capitoken.org</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <hr class="hr" />

  <!-- LAUNCH PANEL -->
  <section class="section" id="launchpanel">
    <div class="container reveal reveal--3">
      <div class="section-block">
      <h2 class="section-title section-title--split"><span class="title-main">Launch Panel</span><span class="title-slash"> / </span><span class="title-kicker">Single source of truth for contract, DEX pair, and status.</span></h2>

      <div class="trust-badges" aria-label="Trust badges">
        <span class="badge" id="badgeContract">Contract: Pending</span>
        <span class="badge" id="badgePair">Pair: Pending</span>
        <span class="badge" id="badgeMarket">Market: Pending</span>
      </div>

      <div class="launch-grid">
        <div class="launch-row">
          <!-- Contract -->
          <div class="card">
            <div class="card__title">CAPI Contract</div>

            <div class="card__body">
              <div class="addr-row">
                <span class="mono addr" id="contractShort">TBA ‚Äî verify only here</span>
                <div class="addr-actions">
                  <button class="btn btn--mini btn--primary" id="copyContractBtn" type="button">Copy</button>
                  <a class="btn btn--mini" id="verifyContractBtn" href="#" target="_blank" rel="noreferrer noopener">Etherscan</a>
                </div>
              </div>

              <details class="addr-details" id="contractDetails" style="display:none;">
                <summary>Show full address</summary>
                <div class="mono" id="contractFull"></div>
              </details>

              <div id="accountPill" class="pill" style="margin-top:12px; display:none;">
                <span class="pill-dot"></span>
                <span class="mono" id="acct">‚Äî</span>
              </div>

              <p class="small note" style="margin-top:12px;">
                Read-only verification. No approvals. Never sign "verify" prompts. If it‚Äôs not listed on this site, assume it‚Äôs not official.
              </p>
            </div>

            <div class="card__footer">
              <div class="small">Wallet tools</div>
              <div class="actions" style="margin-top:10px;">
                <button class="btn" id="connectWalletBtn" type="button">Connect Wallet</button>
                <button class="btn" id="watchTokenBtn" type="button">Add to MetaMask</button>
              </div>
            </div>
          </div>

          <!-- DEX Pair -->
          <div class="card">
            <div class="card__title">CAPI DEX Pair</div>

            <div class="card__body">
              <div class="addr-row">
                <span class="mono addr" id="pairShort">TBA</span>
                <div class="addr-actions">
                  <button class="btn btn--mini btn--primary" id="copyPairBtn" type="button">Copy</button>
                  <a class="btn btn--mini" id="verifyPairBtn" href="#" target="_blank" rel="noreferrer noopener">Etherscan</a>
                </div>
              </div>

              <details class="addr-details" id="pairDetails" style="display:none;">
                <summary>Show full pair</summary>
                <div class="mono" id="pairFull"></div>
              </details>

              <p class="small note" style="margin-top:12px;">
                Only use official swap links from this panel. Scammers often publish fake pairs.
              </p>
            </div>

            <div class="card__footer">
              <div class="actions">
                <a class="btn btn--primary" id="buyOnUniswap" href="#" target="_blank" rel="noreferrer noopener nofollow">Buy $CAPI</a>
                <a class="btn" id="openDexScreener" href="#" target="_blank" rel="noreferrer noopener">Live Market</a>
              </div>

              <div class="small" style="margin-top:10px;">Quick Uniswap routes</div>
              <div class="actions" style="margin-top:10px;">
                <a class="btn route-btn" id="dexWethToCapi" href="#" rel="nofollow noopener">WETH ‚Üí CAPI</a>
                <a class="btn route-btn" id="dexCapiToWeth" href="#" rel="nofollow noopener">CAPI ‚Üí WETH</a>
              </div>
            </div>
          </div>
        </div>

        <div class="launch-row">
          <!-- CAPI Pulse (Live) -->
          <div class="card">
            <div class="card__title">CAPI Pulse</div>
            <div class="small">Simple live stats via DexScreener. If blocked by extensions, you‚Äôll see placeholders.</div>

            <div class="pill" style="margin-top:10px;">
              <span class="pill-dot"></span>
              <span id="pulseNetwork">Ethereum Mainnet</span>
            </div>

            <div class="stats" style="margin-top:14px;">
              <div class="stat"><div class="k">Price</div><div class="v" id="mPrice">TBA</div></div>
              <div class="stat"><div class="k">Market Cap (est.)</div><div class="v" id="mMcap">TBA</div></div>
              <div class="stat"><div class="k">Liquidity</div><div class="v" id="mLiq">TBA</div></div>
              <div class="stat"><div class="k">24h Volume</div><div class="v" id="mVol">TBA</div></div>
              <div class="stat"><div class="k">24h Buys / Sells</div><div class="v" id="pulseBS">‚Äî</div></div>
              <div class="stat"><div class="k">Pair age</div><div class="v" id="pulseAge">‚Äî</div></div>
            </div>

            <p class="small" style="margin-top:12px;">
              If it‚Äôs not listed here, it‚Äôs not official. Always cross-check the URL.
            </p>
          </div>

          <!-- Wallet Hangar -->
          <div class="card">
            <div class="card__title">CAPI Wallet Hangar</div>
            <div class="small">Pick your wallet. (Connecting is optional; Launch Panel stays read-only by default.)</div>

            <div class="venue-grid" id="walletGrid" aria-live="polite" style="margin-top:12px;"></div>

            <div class="small" style="margin-top:10px; opacity:.85;">
              Tip: For maximum safety, verify contract on <b>/verify</b> before importing tokens into any wallet.
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </section>

  <!-- PHASE 9 ‚Äì Markets (DEX / CEX) -->
  <section class="section" id="venues">
    <div class="container reveal">
      <div class="section-block">
      <div class="section__head">
        <h2 class="section-title section-title--split"><span class="title-main">Markets</span><span class="title-slash"> / </span><span class="title-kicker">Official links only. If it‚Äôs not here, it‚Äôs not official.</span></h2>
      </div>

      <div class="venues">
        <div class="venue-block">
          <div class="venue-title">CAPI DEX Markets</div>
          <div class="venue-grid" id="dexGrid" aria-live="polite"></div>
          <div class="small venue-hint">Live once the verified pair is published.</div>
        </div>

        <div class="venue-block">
          <div class="venue-title">CAPI CEX Watchlist</div>
          <div class="venue-grid" id="cexGrid" aria-live="polite"></div>
          <div class="small venue-hint">CEX links will appear here once official listings go live.</div>
        </div>
      </div>
      </div>
    </div>
  </section>

  <script type="module">
    // Phase 9: Trading venues data (editable via /public/venues.json)
    const makeEl = (tag, attrs = {}, children = []) => {
      const el = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (k === "class") el.className = v;
        else if (k === "html") el.innerHTML = v;
        else if (v !== undefined) el.setAttribute(k, String(v));
      }
      for (const c of children) el.append(c);
      return el;
    };

    const safeUrl = (u) => {
      try { return new URL(u).toString(); } catch { return ""; }
    };

    // Fallback local (si /public/venues.json no est√° disponible)
    // Nota: La lista exacta por ‚Äútop volumen‚Äù cambia d√≠a a d√≠a.
    // Aqu√≠ dejamos una selecci√≥n estable de venues grandes y reconocibles.
    const fallback = {
      dex: [
        { name: "Uniswap", url: "https://app.uniswap.org/", iconDomain: "uniswap.org", enabled: true, note: "Enabled" },
        { name: "PancakeSwap", url: "https://pancakeswap.finance/swap", iconDomain: "pancakeswap.finance", enabled: false, note: "Pending" },
        { name: "Curve", url: "https://curve.fi/", iconDomain: "curve.fi", enabled: false, note: "Pending" },
        { name: "Raydium", url: "https://raydium.io/swap/", iconDomain: "raydium.io", enabled: false, note: "Pending" },
        { name: "Orca", url: "https://www.orca.so/", iconDomain: "orca.so", enabled: false, note: "Pending" },
        { name: "Aerodrome", url: "https://aerodrome.finance/swap", iconDomain: "aerodrome.finance", enabled: false, note: "Pending" },
        { name: "SushiSwap", url: "https://www.sushi.com/swap", iconDomain: "sushi.com", enabled: false, note: "Pending" },
        { name: "1inch", url: "https://app.1inch.io/", iconDomain: "1inch.io", enabled: false, note: "Pending" }
      ],
      cex: [
        // Binance: icono expl√≠cito (favicon oficial). Si falla, cae al fallback (iniciales).
        { name: "Binance", url: "https://www.binance.com/", icon: "https://www.binance.com/favicon.ico", iconDomain: "binance.com", enabled: false, note: "Coming soon" },
        { name: "Coinbase", url: "https://www.coinbase.com/", iconDomain: "coinbase.com", enabled: false, note: "Coming soon" },
        { name: "Upbit", url: "https://upbit.com/", iconDomain: "upbit.com", enabled: false, note: "Coming soon" },
        { name: "OKX", url: "https://www.okx.com/", iconDomain: "okx.com", enabled: false, note: "Coming soon" },
        { name: "Bybit", url: "https://www.bybit.com/", iconDomain: "bybit.com", enabled: false, note: "Coming soon" },
        { name: "Bitget", url: "https://www.bitget.com/", iconDomain: "bitget.com", enabled: false, note: "Coming soon" },
        { name: "Gate", url: "https://www.gate.io/", iconDomain: "gate.io", enabled: false, note: "Coming soon" },
        { name: "KuCoin", url: "https://www.kucoin.com/", iconDomain: "kucoin.com", enabled: false, note: "Coming soon" }
      ]
    };

    async function loadVenues(){
      const url = new URL("venues.json", window.location.href).toString();
      try{
        const r = await fetch(url, { cache: "no-store" });
        if(!r.ok) throw new Error("venues fetch failed");
        const data = await r.json();
        if(!data || (!Array.isArray(data.dex) && !Array.isArray(data.cex))) throw new Error("venues shape invalid");
        return { dex: Array.isArray(data.dex)? data.dex : [], cex: Array.isArray(data.cex)? data.cex : [] };
      }catch{
        return fallback;
      }
    }

    function makeIconFallback(name){
      const s = (name || "?").trim();
      const parts = s.split(/\s+/).filter(Boolean);
      const a = (parts[0] || "?").slice(0, 1);
      const b = (parts[1] || "").slice(0, 1);
      return (a + b).toUpperCase();
    }

    // External icon strategy (Option B): multi-source cascade.
    // Goal: never break layout; if all sources fail -> initials fallback.
    // Sources (in order): explicit icon URL -> icon.horse -> clearbit -> Google S2.
    // Some venues (Binance / 1inch) may return generic icons from favicon services.
    // We force a first-choice icon from a CDN that tends to be more stable.
    function forcedIcons(it){
      const n = (it && it.name) ? String(it.name).toLowerCase() : "";
      const out = [];

      // External icon overrides (micro-fix): force reliable logos for venues that often return generic favicons.
      // We still keep the normal cascade (icon.horse -> clearbit -> Google S2) below.

      // Binance: brand yellow
      if(n === "binance"){
        out.push("https://cdn.simpleicons.org/binance/f0b90b");
      }

      // 1inch: Simple Icons slug is usually "1inch" (we also try legacy/alt slug)
      if(n === "1inch" || n.includes("1inch")){
        out.push("https://cdn.simpleicons.org/1inch/ffffff");
        out.push("https://cdn.simpleicons.org/oneinch/ffffff");
      }

      // Balancer
      if(n === "balancer"){
        out.push("https://cdn.simpleicons.org/balancer/ffffff");
      }

      // 0x: try multiple slugs + direct brand domains
      if(n === "0x" || n === "0x protocol" || n.includes("0x")){
        out.push("https://cdn.simpleicons.org/0x/ffffff");
        out.push("https://cdn.simpleicons.org/0xprotocol/ffffff");
        out.push("https://logo.clearbit.com/0x.org?size=64");
        out.push("https://icon.horse/icon/0x.org?size=64");
      }

      // KuCoin: prefer brand green (then white fallback)
      if(n === "kucoin" || n.includes("kucoin")){
        out.push("https://cdn.simpleicons.org/kucoin/31cb9e");
        out.push("https://cdn.simpleicons.org/kucoin/ffffff");
      }

      // Upbit: prefer brand blue (then white fallback)
      if(n === "upbit" || n.includes("upbit")){
        out.push("https://cdn.simpleicons.org/upbit/093687");
        out.push("https://cdn.simpleicons.org/upbit/ffffff");
      }

      return out.filter(Boolean);
    }
function iconCandidates(it){
      const out = [];
      const forced = forcedIcons(it);
      if(forced && forced.length) forced.forEach((u)=>out.push(u));
      if(it && it.icon) out.push(String(it.icon));
      const d = (it && it.iconDomain) ? String(it.iconDomain).trim() : "";
      if(d){
        out.push(`https://icon.horse/icon/${encodeURIComponent(d)}?size=64`);
        out.push(`https://logo.clearbit.com/${encodeURIComponent(d)}?size=64`);
        out.push(`https://www.google.com/s2/favicons?domain=${encodeURIComponent(d)}&sz=64`);
      }
      // De-dup while preserving order
      return out.filter((u, i) => u && out.indexOf(u) === i);
    }

    function renderGrid(targetId, items){
      const host = document.getElementById(targetId);
      if(!host) return;

      host.innerHTML = "";
      items.forEach((it) => {
        const href = safeUrl(it.url);
        const enabled = Boolean(it.enabled) && href;
        const a = makeEl(enabled ? "a" : "div", {
          class: "venue-tile" + (enabled ? "" : " is-disabled"),
          href: enabled ? href : undefined,
          target: enabled ? "_blank" : undefined,
          rel: enabled ? "noreferrer noopener" : undefined
        });

        // Icon: evitamos que el texto del alt se renderice cuando el icono falla.
        // Accesibilidad: ponemos el nombre en aria-label del tile.
        a.setAttribute("aria-label", it.name || "Venue");

        const iconWrap = makeEl("div", { class: "venue-iconwrap" });

        const img = makeEl("img", {
          class: "venue-icon",
          alt: "", // <- clave para evitar texto superpuesto si falla
          loading: "lazy",
          referrerpolicy: "no-referrer"
        });

        const addFallback = () => {
          if(iconWrap.querySelector(".venue-icon-fallback")) return;
          const fb = makeEl("div", { class: "venue-icon-fallback", html: makeIconFallback(it.name) });
          iconWrap.append(fb);
        };

        const candidates = iconCandidates(it);

        const setNext = () => {
          const next = candidates.shift();
          if(!next){
            try { img.remove(); } catch {}
            addFallback();
            return;
          }
          // Simple-icons SVGs can be monochrome. If no explicit color is provided, we boost contrast on dark glass UI.
          const isSimple = next.includes("cdn.simpleicons.org/");
          const hasColor = /cdn\.simpleicons\.org\/[^\/]+\/[0-9a-fA-F]{3,6}$/.test(next);
          img.classList.toggle("is-mono", isSimple && !hasColor);
          img.setAttribute("src", next);
        };

        if(!candidates.length){
          addFallback();
        }else{
          img.addEventListener("error", () => {
            // Try next external source. If all fail, fallback initials.
            setNext();
          });
          // Start with best candidate.
          setNext();
          iconWrap.append(img);
        }

        const name = makeEl("div", { class: "venue-name", html: (it.name || "Venue") });
        const note = makeEl("div", { class: "venue-note small", html: (it.note || (enabled ? "Enabled" : "Pending")) });

        a.append(iconWrap, makeEl("div", { class: "venue-meta" }, [name, note]));
        host.append(a);
      });

      if(!items.length){
        host.append(makeEl("div", { class: "small", html: "No venues published yet." }));
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const data = await loadVenues();
      renderGrid("dexGrid", data.dex);
      renderGrid("cexGrid", data.cex);
    });
  </script>

  <hr class="hr" />

  <!-- TOKENOMICS -->
  <section class="section" id="tokenomics">
    <div class="container reveal">
      <div class="section-block">
      <h2 class="section-title section-title--split"><span class="title-main">Tokenomics</span><span class="title-slash"> / </span><span class="title-kicker">Simple. Honest. Unbreakable math ‚Äî <strong>97 / 2 / 1</strong>.</span></h2>

      <!-- Supply quick facts (from Whitepaper Key Facts) -->
      <div class="tokenomics-supplybar" aria-label="Token supply quick facts" style="margin-top:12px;">
        <span class="tokenomics-supplybar__label">Total Supply</span>
        <span class="tokenomics-supplybar__value">100,000,000,000 CAPI</span>
        <span class="tokenomics-supplybar__sep">‚Ä¢</span>
        <span class="tokenomics-supplybar__meta">Fixed</span>
        <span class="tokenomics-supplybar__sep">‚Ä¢</span>
        <span class="tokenomics-supplybar__meta">18 Decimals</span>
        <span class="tokenomics-supplybar__sep">‚Ä¢</span>
        <span class="tokenomics-supplybar__meta">ERC‚Äë20</span>
      </div>

      <div class="tokenomics-wrap">
        <!-- TRUST RING (narrative) -->
        <div class="tokenomics-ring" id="tokenomicsNarrative">
          <!-- Ring + narrative notes in one stage:
               - Ring stays same size.
               - Notes live to the LEFT, stacked.
               - On hover over a ring segment, the matching note slides right ("reveal" effect).
          -->
          <div class="tokenomics-ringrow" id="tokenomicsRingRow" data-active="none">
            <div class="tokenomics-notes-stack" aria-hidden="true">
              <div class="tokenomics-mascot-card" aria-label="Capitoken mascot">
                <img class="tokenomics-mascot-img" src={withBase("/img/capi-cartoon.png")} alt="Capitoken mascot" loading="lazy" decoding="async" />
              </div>
                            <div class="tokenomics-unibox" aria-hidden="true">
                <!-- One message box (messages slide-in based on data-active) -->
                <div class="tok-msg" data-whisper="community"><span class="tok-msg__text">ü¶´ No whales here. Just chill capis.</span></div>
                <div class="tok-msg" data-whisper="ops"><span class="tok-msg__text">ü¶´ Yes, devs eat too. But just a snack.</span></div>
                <div class="tok-msg" data-whisper="growth"><span class="tok-msg__text">ü¶´ Marketing = memes, not Lambos.</span></div>
                <div class="tok-msg" data-whisper="ambient"><span class="tok-msg__text">ü¶´ Capibara doesn‚Äôt rush. Neither does supply.</span></div>
                <div class="tok-msg" data-whisper="fixed"><span class="tok-msg__text">ü¶´ Fixed supply. No minting magic.</span></div>
                <div class="tok-msg" data-whisper="taxes"><span class="tok-msg__text">ü¶´ No hidden taxes. Clean swaps only.</span></div>
                <div class="tok-msg" data-whisper="renounce"><span class="tok-msg__text">ü¶´ Token keys go to the river. Verifiable on-chain.</span></div>
              </div>
</div>
            </div>

            <div class="tokenomics-stage">
              <div class="trust-ring" id="tokenomicsRing" data-seg="community" aria-label="Tokenomics allocation ring" role="img">
                <div class="trust-ring__core">
                  <div class="trust-ring__pct" id="trustRingPct">97%</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- TRUST BADGES / RULES -->
        <div class="tokenomics-rules">
          <!-- Row 1: Fixed Supply (left) + No Hidden Taxes (right) -->
          <div class="card tokenomics-rule" id="tokenomicsFixedSupply">
            <div class="tokenomics-rule__top">üîí Fixed Supply</div>
            <div class="small"><b>100,000,000,000 CAPI</b> ‚Äî No minting. Ever.</div>
          </div>
          <div class="card tokenomics-rule" id="tokenomicsNoTaxes">
            <div class="tokenomics-rule__top">üßØ No Hidden Taxes</div>
            <div class="small">What you see is what you trade.</div>
          </div>

          <!-- Row 2: Anti-bot (left) + Token Ownership Renounce (right) -->
          <div class="card tokenomics-rule" id="tokenomicsAntiBot">
            <div class="tokenomics-rule__top">üß† Anti-bot Phase</div>
            <div class="small">Temporary. Transparent. Timed.</div>
          </div>
          <div class="card tokenomics-rule" id="tokenomicsRenounce">
            <div class="tokenomics-rule__top">üîë Token Ownership Renounce</div>
            <div class="small">Planned. Announced. Verifiable.</div>
          </div>

          <div class="card tokenomics-split">
            <div class="tokenomics-split__row"><span>üü¢ Community</span><strong>97%</strong></div>
            <div class="tokenomics-split__row"><span>üü° Ops / Dev</span><strong>2%</strong></div>
            <div class="tokenomics-split__row"><span>üü† Growth / Marketing</span><strong>1%</strong></div>
            <div class="small" style="margin-top:10px;">Tip: Treat this page as the truth source. If it‚Äôs not listed here, assume it‚Äôs not official.</div>
          </div>
        </div>
      </div>
      </div>
    </div>


  <script>
    // Tokenomics WOW: change ring center copy by hovering segments (no heavy JS)
    (function(){
      const ring = document.getElementById('tokenomicsRing');
      const row = document.getElementById('tokenomicsRingRow');
      const pct = document.getElementById('trustRingPct');
            if(!ring || !pct) return;
      const segments = {
        community: { pct: '97%' },
        ops: { pct: '2%' },
        growth: { pct: '1%' }
      };

      // Degrees: conic-gradient starts at 0deg (top) and goes clockwise.
      const pCommunity = 97;
      const pOps = 2;
      const endCommunity = pCommunity * 3.6;          // 349.2
      const endOps = (pCommunity + pOps) * 3.6;       // 356.4

      function setSeg(key){
        const s = segments[key] || segments.community;
        ring.dataset.seg = key;
        pct.textContent = s.pct;
      }

      function angleFromEvent(ev){
        const rect = ring.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        const x = (ev.clientX ?? (ev.touches && ev.touches[0] && ev.touches[0].clientX)) - cx;
        const y = (ev.clientY ?? (ev.touches && ev.touches[0] && ev.touches[0].clientY)) - cy;
        if(!isFinite(x) || !isFinite(y)) return null;
        let deg = Math.atan2(y, x) * 180 / Math.PI; // -180..180, 0 at +x
        deg = (deg + 90 + 360) % 360; // 0 at top, clockwise
        return deg;
      }

      function segFromDeg(deg){
        if(deg == null) return 'community';
        if(deg < endCommunity) return 'community';
        if(deg < endOps) return 'ops';
        return 'growth';
      }

      // Desktop: hover/move (notes reveal ONLY while hovering the ring)
      let hoveringRing = false;

      ring.addEventListener('mouseenter', () => {
        hoveringRing = true;
      });

      ring.addEventListener('mousemove', (ev) => {
        if(!hoveringRing) return;
        const deg = angleFromEvent(ev);
        const k = segFromDeg(deg);
        if(row) row.dataset.active = k;
        setSeg(k);
      });

      ring.addEventListener('mouseleave', () => {
        hoveringRing = false;
        if(row) row.dataset.active = 'none';
        setSeg('community');
      });

// Mobile: tap cycles (no precision required)
      const order = ['community','ops','growth'];
      ring.addEventListener('touchstart', (ev) => {
        ev.preventDefault();
        const cur = ring.dataset.seg || 'community';
        const next = order[(order.indexOf(cur)+1) % order.length];
        if(row) row.dataset.active = next;
        setSeg(next);
        window.setTimeout(()=>{ if(row) row.dataset.active='none'; }, 1200);
      }, { passive: false });
      // Reveal the ambient note when hovering the Anti-bot card (no layout change on the right)
      const antiBotCard = document.getElementById('tokenomicsAntiBot');
      if(antiBotCard && row){
        antiBotCard.addEventListener('mouseenter', () => { row.dataset.active = 'ambient'; });
        antiBotCard.addEventListener('mouseleave', () => { row.dataset.active = 'none'; });
      }

      // Reveal the right-side rule bubbles without changing the right-side layout.
      const fixedCard = document.getElementById('tokenomicsFixedSupply');
      if(fixedCard && row){
        fixedCard.addEventListener('mouseenter', () => { row.dataset.active = 'fixed'; });
        fixedCard.addEventListener('mouseleave', () => { row.dataset.active = 'none'; });
      }

      const taxesCard = document.getElementById('tokenomicsNoTaxes');
      if(taxesCard && row){
        taxesCard.addEventListener('mouseenter', () => { row.dataset.active = 'taxes'; });
        taxesCard.addEventListener('mouseleave', () => { row.dataset.active = 'none'; });
      }

      const renounceCard = document.getElementById('tokenomicsRenounce');
      if(renounceCard && row){
        renounceCard.addEventListener('mouseenter', () => { row.dataset.active = 'renounce'; });
        renounceCard.addEventListener('mouseleave', () => { row.dataset.active = 'none'; });
      }

      // initial
      if(row) row.dataset.active = 'none';
      setSeg('community');
    })();
  </script>
  </section>

  <hr class="hr" />

  <!-- ROADMAP -->
  <section class="section" id="roadmap">
    <div class="container reveal">
      <div class="section-block">
        <h2 class="section-title section-title--split"><span class="title-main">Roadmap</span><span class="title-slash"> / </span><span class="title-kicker">From Launch To a Community Future.</span></h2>

        <div class="rm-grid">
          {roadmap.map((r, idx) => (
            <article class="rm-card" id={r.id}>
              <div class="rm-top">
                <div class="rm-headrow">
                  <h3 class="rm-heading">
                    <span class="rm-heading__phase">{r.phase}</span>
                    <span class="rm-heading__dash">‚Äî</span>
                    <span class="rm-heading__title">{r.title}</span>
                  </h3>
                  <span class="rm-status" data-status={r.status}>{r.status}</span>
                </div>
                <p class="rm-objective">
                  <span class="rm-obj-label">Objective:</span> {r.objective}
                </p>
              </div>

              <!-- Image placeholder (card/box). We will replace with real illustrations next. -->
              <div class={"rm-media rm-media--" + (idx + 1)} aria-hidden="true"></div>

              <div class="rm-body">
                <div class="rm-subhead">Key Notes</div>
                <ul class="rm-points">
                  {r.items.map((it) => (
                    <li>
                      <strong>{it.t}</strong>
                      <span class="rm-note"> ‚Äî {it.d}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </article>
          ))}
        </div>

        <div class="rm-legal" role="note" aria-label="Roadmap note">
          <div class="rm-legal__icon" aria-hidden="true">‚ö†Ô∏è</div>
          <div class="rm-legal__text">
            <strong>All future initiatives are optional, community-driven, and developed without altering the core CAPI smart contract.</strong>
            <div class="small" style="margin-top:6px;">
              This protects the project legally and technically, and keeps the narrative community-first.
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top:14px;">
          <div class="card col-6">
            <h3>Have ideas?</h3>
            <p class="small">Roadmap items can evolve as the community grows. We post verified updates here first.</p>
            <a class="btn btn--primary" href={`https://twitter.com/${X_HANDLE}`} target="_blank" rel="noreferrer">Reply on X</a>
          </div>
          <div class="card col-6">
            <h3>Build in public</h3>
            <p class="small">Bookmark this page. Verified links and updates belong here ‚Äî then mirrored to socials.</p>
            <a class="btn" href="#launchpanel">Back to Launch Panel</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <hr class="hr" />

  <!-- COMMUNITY -->
  <section class="section" id="community">
    <div class="container reveal">
      <div class="section-block">
      <h2 class="section-title section-title--split"><span class="title-main">Community</span><span class="title-slash"> / </span><span class="title-kicker">Official socials ‚Äî X and YouTube.</span></h2>

      <div class="grid community-grid" style="margin-top:14px;">
        <!-- X (Twitter) -->
        <div class="card col-6 community-card">
          <div class="card__title">Official X</div>
          <p class="small">If the embed is blank, your browser/extensions may block it. The official link still works.</p>

          <div class="actions" style="margin-top:10px;">
            <a class="btn btn--primary" href={`https://twitter.com/${X_HANDLE}`} target="_blank" rel="noreferrer noopener">
              Open @${X_HANDLE}
            </a>
          </div>

          <div class="community-embed community-embed--x" style="margin-top:14px;">
            <a class="twitter-timeline"
               data-theme="dark"
               data-show-replies="true"
               data-tweet-limit="5"
               data-chrome="noheader nofooter noborders transparent"
               href={`https://twitter.com/${X_HANDLE}`}>
               Tweets by {X_HANDLE}
            </a>
          </div>

          <p class="small note" style="margin-top:12px;">
            Anti-scam: Only trust links published on this website.
          </p>
        </div>

        <!-- YouTube (Fixed video) -->
        <div class="card col-6 community-card">
          <div class="card__title">Official YouTube</div>
          <p class="small">Pinned video for announcements, explainers, and community updates.</p>

          <div class="actions" style="margin-top:10px;">
            <a class="btn btn--primary" href={`https://www.youtube.com/@${YT_HANDLE}`} target="_blank" rel="noreferrer noopener">
              Open @${YT_HANDLE}
            </a>
            <a class="btn" href={`https://www.youtube.com/channel/${YT_CHANNEL_ID}`} target="_blank" rel="noreferrer noopener">
              Channel ID
            </a>
          </div>

          <div class="community-embed community-embed--yt" style="margin-top:14px;">
            {YT_VIDEO_ID ? (
              <div class="yt-embed">
                <iframe
                  src={`https://www.youtube-nocookie.com/embed/${YT_VIDEO_ID}`}
                  title="Capitoken ‚Äî Official YouTube Video"
                  loading="lazy"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen
                ></iframe>
              </div>
            ) : (
              <div class="yt-placeholder">
                <div class="small">
                  <b>Video fijo pendiente:</b> edita <span class="mono">YT_VIDEO_ID</span> en <span class="mono">index.astro</span>.
                </div>
                <div class="small" style="margin-top:8px; opacity:.85;">
                  Mientras tanto, usa el bot√≥n ‚ÄúOpen @CapiToken‚Äù para ver el canal oficial.
                </div>
              </div>
            )}
          </div>

          <p class="small note" style="margin-top:12px;">
            Anti-scam: This is the only official YouTube referenced by Capitoken.
          </p>
        </div>
      </div>
      </div>
    </div>
  </section>

  <hr class="hr" />

  <!-- FAQ -->
  <section class="section" id="faq">
    <div class="container reveal">
      <div class="section-block">
      <h2 class="section-title section-title--split"><span class="title-main">FAQ</span><span class="title-slash"> / </span><span class="title-kicker">Quick answers. Zero fluff.</span></h2>

      <div class="grid faq-grid" style="margin-top:14px;">
        <div class="card col-4 faq-card">
          <h3>Where is the official contract?</h3>
          <p class="small">Only the Launch Panel and /verify publish the official contract address. If it‚Äôs not here, it‚Äôs not official.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>What is the total supply?</h3>
          <p class="small"><b>100,000,000,000 CAPI</b> (fixed). Standard ERC‚Äë20, 18 decimals.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>Can supply change later?</h3>
          <p class="small">No minting. No hidden ‚Äúsupply switch.‚Äù Any claim of ‚Äúnew supply‚Äù is a scam signal.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>Are there buy/sell taxes?</h3>
          <p class="small">No hidden taxes. What you see is what you trade. Always verify the token contract before swapping.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>When does ownership renounce?</h3>
          <p class="small">Exactly 90 days after trading activation (Jan 17, 2026 ‚Üí Apr 17, 2026). Projected: April 17, 2026. It will be announced and verifiable on-chain.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>What is the anti-bot phase?</h3>
          <p class="small">A temporary, transparent set of launch protections (e.g., cooldown/limits) designed to reduce sniping and early manipulation. Once ownership is renounced, these restrictions are lifted and CAPI becomes fully permissionless for normal trading.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>Where do I trade safely?</h3>
          <p class="small">Use official swap links from the Launch Panel only. Fake pairs are the #1 scam vector.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>How do I add CAPI to my wallet?</h3>
          <p class="small">Verify the contract on /verify, then import the token in your wallet using the contract address + symbol ‚ÄúCAPI‚Äù + decimals ‚Äú18‚Äù. If you use MetaMask, the Launch Panel button can auto‚Äëfill it.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>Why verify only here?</h3>
          <p class="small">Scammers clone brands and UIs. This site is the single source of truth for official links and addresses.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>Why is my trust score lower on a mirror?</h3>
          <p class="small">Mirrors can be useful, but only <b>www.capitoken.org</b> is the canonical source. The UI flags mirrors by design.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>When will live market data appear?</h3>
          <p class="small">Once the verified pair is published, live metrics auto‚Äëpopulate. If you see data elsewhere first, treat it as unverified.</p>
        </div>

        <div class="card col-4 faq-card">
          <h3>Is this financial advice?</h3>
          <p class="small">No. Crypto is high‚Äërisk. You are responsible for your decisions. Never invest more than you can afford to lose.</p>
        </div>
      </div>
      </div>
    </div>
  </section>

  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite" style="position:fixed;left:16px;bottom:16px;opacity:0;transform:translateY(8px);transition:all .2s;pointer-events:none;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.15);padding:10px 12px;border-radius:12px;font-size:.95rem;"></div>

  <!-- X widget loader -->
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

  <!-- Live + Wallet script -->
  <script is:inline type="module" define:vars={{ TOKEN_ADDRESS, DEX_PAIR_ADDRESS }}>
    const ENGINE_V = new URL(window.location.href).searchParams.get("v") || "PHASE9PULSE_R1";

    const $id = (id) => document.getElementById(id);

    let explorerBase = "https://etherscan.io";
    let networkName = "Ethereum Mainnet";
    let tokenAddr = TOKEN_ADDRESS || "";
    let pairAddr = DEX_PAIR_ADDRESS || "";
    let tokenMeta = { symbol: "CAPI", decimals: 18, image: "" };

    const toast = (msg) => {
      const el = $id("toast");
      if(!el) return;
      el.textContent = msg;
      el.style.opacity = "1";
      el.style.transform = "translateY(0)";
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=>{
        el.style.opacity = "0";
        el.style.transform = "translateY(8px)";
      }, 1800);
    };

    async function copyText(val){
      if(!val) return;
      try{
        await navigator.clipboard.writeText(val);
        toast("Copied");
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = val;
        ta.setAttribute("readonly","");
        ta.style.position="absolute";
        ta.style.left="-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Copied");
      }
    }

    function short(a){
      if(!a) return "";
      return a.slice(0,6)+"‚Ä¶"+a.slice(-4);
    }

    function fmtUSD(n, d=2){
      if(n === null || n === undefined || Number.isNaN(Number(n))) return "TBA";
      return Number(n).toLocaleString(undefined, { style:"currency", currency:"USD", maximumFractionDigits:d });
    }

    function setTxt(id, v){
      const el = $id(id);
      if(el) el.textContent = v;
    }
    function setWidth(id, pct){
      const el = $id(id);
      if(el) el.style.width = `${Math.max(0, Math.min(100, Number(pct)||0))}%`;
    }

    async function loadRegistry(){
      try{
        const url = new URL("official-registry.json", window.location.href).toString() + `?v=${ENGINE_V}`;
        const r = await fetch(url, { cache:"no-store" });
        if(!r.ok) throw new Error("registry fetch failed");
        return await r.json();
      }catch{
        return null;
      }
    }

    function scoreFrom(reg, isOfficialHost){
      let s = 60;
      if(isOfficialHost) s += 20;
      if(reg?.contract?.verified) s += 10;
      if(reg?.pair?.address) s += 5;
      if(reg?.links && Object.keys(reg.links).length) s += 5;
      return Math.max(0, Math.min(100, s));
    }

    async function initTrustHero(){
      const data = await loadRegistry();

      explorerBase = String(data?.network?.explorer || explorerBase);
      networkName = String(data?.network?.name || networkName);
      tokenAddr = String(data?.contract?.address || tokenAddr || "");
      pairAddr = String((data?.pair?.address) || pairAddr || "");
      tokenMeta = {
        symbol: String(data?.contract?.token?.symbol || tokenMeta.symbol || "CAPI"),
        decimals: Number(data?.contract?.token?.decimals ?? tokenMeta.decimals ?? 18),
        image: String(data?.links?.tokenImage || tokenMeta.image || "")
      };

      const host = window.location.hostname;
      const allowed = new Set((data?.allowedDomains || []).map((x) => String(x).toLowerCase()));
      const isOfficialHost = allowed.size ? allowed.has(String(host).toLowerCase()) : true;

      const score = scoreFrom(data, isOfficialHost);
      setTxt("trustScoreHero", String(score));
      setWidth("trustBarFill", score);

      const pb = $id("trustBarHero");
      if (pb) pb.setAttribute("aria-valuenow", String(score));

      const status = isOfficialHost ? "VERIFIED OFFICIAL DOMAIN" : "MIRROR DOMAIN ‚Äî VERIFY NOW";
      setTxt("trustStatusHero", status);

      const hintEl = $id("trustHintHero");
      const mirrorEl = $id("trustMirrorUrl");

      if(!isOfficialHost){
        const hint = data?.security?.mirrorNotice || "You are viewing a mirror. Verify on the official domain.";
        if(hintEl){
          hintEl.hidden = false;
          hintEl.textContent = hint;
        }
        if(mirrorEl && data?.security?.officialUrl) mirrorEl.textContent = String(data.security.officialUrl);
      }else{
        if(hintEl) hintEl.hidden = true;
      }

      const badge = $id("trustBadgeHero");
      if (badge) {
        badge.classList.remove("is-verified", "is-warn");
        badge.classList.add(isOfficialHost ? "is-verified" : "is-warn");
      }

      const netPill = $id("networkPill");
      if (netPill) {
        const spans = netPill.querySelectorAll("span");
        if (spans.length) spans[spans.length - 1].textContent = networkName;
      }
      setTxt("pulseNetwork", networkName);
    }

    function setBadge(id, label){
      const el = $id(id);
      if(el) el.textContent = label;
    }

    function setLaunchTexts(){
      if(tokenAddr){
        setBadge("badgeContract", "Contract: Live");
        setTxt("contractShort", short(tokenAddr));
        setTxt("contractFull", tokenAddr);
        $id("contractDetails")?.style?.setProperty("display","block");
        const v = $id("verifyContractBtn");
        if(v) v.href = `${explorerBase}/token/${tokenAddr}`;
      }else{
        setBadge("badgeContract", "Contract: Pending");
      }

      if(pairAddr){
        setBadge("badgePair", "Pair: Live");
        setTxt("pairShort", short(pairAddr));
        setTxt("pairFull", pairAddr);
        $id("pairDetails")?.style?.setProperty("display","block");
        const v = $id("verifyPairBtn");
        if(v) v.href = `${explorerBase}/address/${pairAddr}`;
      }else{
        setBadge("badgePair", "Pair: Pending");
      }
    }

    function setDexLinks(){
      const weth = "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2";
      if(tokenAddr){
        const buy = `https://app.uniswap.org/#/swap?inputCurrency=${weth}&outputCurrency=${tokenAddr}`;
        const sell = `https://app.uniswap.org/#/swap?inputCurrency=${tokenAddr}&outputCurrency=${weth}`;
        const dex = pairAddr ? `https://dexscreener.com/ethereum/${pairAddr}` : `https://dexscreener.com/ethereum/${tokenAddr}`;

        const aBuy = $id("buyOnUniswap"); if(aBuy) aBuy.href = buy;
        const aDex = $id("openDexScreener"); if(aDex) aDex.href = dex;

        const r1 = $id("dexWethToCapi"); if(r1) r1.href = buy;
        const r2 = $id("dexCapiToWeth"); if(r2) r2.href = sell;
      }
    }

    async function connectInjected(){
      try{
        if(!window.ethereum) { toast("No injected wallet detected"); return; }
        const accounts = await window.ethereum.request({ method:"eth_requestAccounts" });
        const a = accounts?.[0];
        if(!a) return;
        const pill = $id("accountPill");
        if(pill) pill.style.display = "inline-flex";
        setTxt("acct", short(a));
      }catch(e){
        console.warn("connectInjected failed", e);
      }
    }

    async function watchToken(){
      try{
        if(!window.ethereum || !tokenAddr) return;
        await window.ethereum.request({
          method: "wallet_watchAsset",
          params: {
            type: "ERC20",
            options: {
              address: tokenAddr,
              symbol: tokenMeta?.symbol || "CAPI",
              decimals: Number(tokenMeta?.decimals ?? 18),
              image: tokenMeta?.image || undefined
            }
          }
        });
        toast("Token added (if supported)");
      }catch(e){
        console.warn("watchToken failed", e);
        toast("Wallet declined / not supported");
      }
    }

    function setMarketBadge(txt){
      setBadge("badgeMarket", txt);
    }

    function humanAge(ts){
      if(!ts) return "‚Äî";
      const t = Number(ts);
      if(!Number.isFinite(t)) return "‚Äî";
      const diff = Date.now() - t;
      const mins = Math.max(0, Math.floor(diff/60000));
      if(mins < 60) return `${mins}m`;
      const hrs = Math.floor(mins/60);
      if(hrs < 48) return `${hrs}h`;
      const days = Math.floor(hrs/24);
      return `${days}d`;
    }

    async function loadDexScreener(){
      if(!tokenAddr && !pairAddr) return;

      try{
        const url = pairAddr
          ? `https://api.dexscreener.com/latest/dex/pairs/ethereum/${pairAddr}`
          : `https://api.dexscreener.com/latest/dex/tokens/${tokenAddr}`;

        const r = await fetch(url, { cache:"no-store" });
        if(!r.ok) throw new Error("dexscreener fetch failed");

        const j = await r.json();
        const p = (j?.pairs && j.pairs[0]) ? j.pairs[0] : null;
        if(!p){ setMarketBadge("Market: Indexing"); return; }

        setMarketBadge("Market: Live");

        $id("mPrice").textContent = fmtUSD(p.priceUsd, 8);
        $id("mLiq").textContent = fmtUSD(p?.liquidity?.usd, 0);
        $id("mVol").textContent = fmtUSD(p?.volume?.h24, 0);

        const mc = p?.marketCap ?? p?.fdv ?? null;
        $id("mMcap").textContent = mc ? fmtUSD(mc, 0) : "TBA";

        const buys = p?.txns?.h24?.buys ?? null;
        const sells = p?.txns?.h24?.sells ?? null;
        setTxt("pulseBS", (Number.isFinite(buys) && Number.isFinite(sells)) ? `${buys} / ${sells}` : "‚Äî");

        const created = p?.pairCreatedAt ?? null;
        setTxt("pulseAge", created ? humanAge(created) : "‚Äî");
      }catch(e){
        setMarketBadge("Market: Blocked");
        console.warn("DexScreener fetch failed", e);
      }
    }

    function renderWalletHangar(){
      const host = $id("walletGrid");
      if(!host) return;

      const wallets = [
        // Nota: usamos el servicio de favicons de Google por dominio para evitar "alt text" superpuesto cuando un favicon falla.
        // Si igual falla, mostramos un fallback con iniciales.
        { name:"MetaMask", url:"https://metamask.io/", iconDomain:"metamask.io", note:"Browser / Mobile" },
        { name:"Trust Wallet", url:"https://trustwallet.com/", iconDomain:"trustwallet.com", note:"Mobile" },
        { name:"Coinbase Wallet", url:"https://www.coinbase.com/wallet", iconDomain:"coinbase.com", note:"Mobile / Browser" },
        { name:"Rainbow", url:"https://rainbow.me/", iconDomain:"rainbow.me", note:"Mobile" },
        { name:"Rabby", url:"https://rabby.io/", iconDomain:"rabby.io", note:"Browser" },
        { name:"Phantom", url:"https://phantom.app/", iconDomain:"phantom.app", note:"Multi-chain" },
        { name:"WalletConnect", url:"https://walletconnect.com/", iconDomain:"walletconnect.com", note:"Connector" },
        { name:"Safe", url:"https://safe.global/", iconDomain:"safe.global", note:"Multisig" },
      ];

      host.innerHTML = "";
      wallets.forEach((it) => {
        const href = (()=>{ try { return new URL(it.url).toString(); } catch { return ""; } })();
        const a = document.createElement("a");
        a.className = "venue-tile";
        a.href = href;
        a.target = "_blank";
        a.rel = "noreferrer noopener";

        // Accesibilidad: el nombre vive en el aria-label del tile.
        a.setAttribute("aria-label", it.name || "Wallet");

        const iconWrap = document.createElement("div");
        iconWrap.className = "venue-iconwrap";

        const addFallback = () => {
          if(iconWrap.querySelector(".venue-icon-fallback")) return;
          const fb = document.createElement("div");
          fb.className = "venue-icon-fallback";
          fb.textContent = makeIconFallback(it.name);
          iconWrap.append(fb);
        };

        const iconSrc = it.icon || (it.iconDomain ? `https://www.google.com/s2/favicons?domain=${encodeURIComponent(it.iconDomain)}&sz=64` : "");

        if(iconSrc){
          const img = document.createElement("img");
          img.className = "venue-icon";
          img.alt = ""; // <- evita texto superpuesto si falla el icono
          img.loading = "lazy";
          img.referrerPolicy = "no-referrer";
          img.addEventListener("error", () => {
            try { img.remove(); } catch {}
            addFallback();
          }, { once: true });
          img.src = iconSrc;
          iconWrap.append(img);
        }else{
          addFallback();
        }

        const meta = document.createElement("div");
        meta.className = "venue-meta";

        const n = document.createElement("div");
        n.className = "venue-name";
        n.textContent = it.name;

        const note = document.createElement("div");
        note.className = "venue-note small";
        note.textContent = it.note || "";

        meta.append(n, note);
        a.append(iconWrap, meta);
        host.append(a);
      });
    }

    function syncNetworkLabels(){
      setTxt("pulseNetwork", networkName);
      document.querySelectorAll('#launchpanel .pill').forEach((pill) => {
        const spans = pill.querySelectorAll('span');
        if (spans.length) {
          const last = spans[spans.length-1];
          if (last && /ethereum/i.test(last.textContent || '')) last.textContent = networkName;
        }
      });
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      await initTrustHero();
      setLaunchTexts();
      setDexLinks();
      syncNetworkLabels();
      renderWalletHangar();

      $id("copyContractBtn")?.addEventListener("click", ()=> copyText(tokenAddr));
      $id("copyPairBtn")?.addEventListener("click", ()=> copyText(pairAddr));

      $id("connectWalletBtn")?.addEventListener("click", connectInjected);
      $id("watchTokenBtn")?.addEventListener("click", watchToken);

      await loadDexScreener();
      setInterval(loadDexScreener, 45000);
    });
  </script>

  <script is:inline>
    (function(){
      try{
        var url = new URL("build.json", window.location.href).toString();
        fetch(url, { cache: "no-store" }).then(function(r){ return r.ok ? r.json() : null; }).then(function(d){
          if(!d || !d.buildId) return;
          var key = "capitoken_build_id";
          var prev = localStorage.getItem(key);
          if(prev && prev !== d.buildId){
            localStorage.setItem(key, d.buildId);
            location.reload();
            return;
          }
          if(!prev) localStorage.setItem(key, d.buildId);
        }).catch(function(){});
      }catch(e){}
    })();
  </script>
</BaseLayout>