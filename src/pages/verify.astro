---
/**
 * Capitoken /verify — Single Source of Truth + Trust Logic
 * - Works with Astro base path (e.g., /capitoken-site/)
 * - Reads official registry from: /official-registry.json (served from public/)
 * - Also supports pair + official links when present
 * - Shows mirror warning if hostname is not allowed
 */

const BASE = import.meta.env.BASE_URL; // respects astro.config.mjs "base"
const FALLBACK = {
  project: "Capitoken",
  version: "1.0.0",
  updatedAt: "2026-01-17",
  officialDomain: "www.capitoken.org",
  allowedDomains: ["www.capitoken.org", "capitoken.org"],
  officialRepo: "https://github.com/capitoken-org/capitoken-site",
  network: { name: "Ethereum Mainnet", chainId: 1, explorer: "https://etherscan.io" },
  contract: {
    address: "0xF2dA6C9B945c688A52D3B72340E622014920de6a",
    verified: true,
    token: { name: "Capitoken", symbol: "CAPI", decimals: 18 }
  },
  security: {
    mirrorsAllowed: true,
    mirrorNotice: "You are viewing a mirror. The official site is https://www.capitoken.org"
  }
};
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Verify | Capitoken</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Respect base path -->
    <link rel="stylesheet" href={`${BASE}global.css`} />

    <style>
      /* Phase 8 small polish for /verify (keeps existing layout) */
      .scorewrap{display:flex;flex-direction:column;gap:10px;margin-top:10px}
      .bar{height:10px;border-radius:999px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10);overflow:hidden}
      .barfill{height:100%;width:0%;background:linear-gradient(90deg, rgba(241,196,15,1), rgba(46,204,113,1));transition:width .85s ease}

      .wrap { max-width: 920px; margin: 80px auto; padding: 0 18px; }
      .h1 { font-size: clamp(28px, 4vw, 44px); line-height: 1.1; margin: 0 0 10px; }
      .sub { opacity:.85; margin: 0 0 18px; }
      .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
      .cardx{
        grid-column: span 12;
        background: rgba(0,0,0,.55);
        border: 1px solid rgba(255,255,255,.10);
        border-radius: 14px;
        padding: 18px;
        backdrop-filter: blur(8px);
      }
      .row { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; word-break: break-all; }
      .tag { font-size: 12px; padding: 6px 10px; border-radius: 999px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.05); }
      .ok { color:#2ecc71; }
      .warn { color:#f1c40f; }
      .bad { color:#e74c3c; }
      .btns { display:flex; gap:10px; flex-wrap:wrap; }
      .btnx{
        display:inline-flex; align-items:center; justify-content:center;
        padding:10px 14px; border-radius:12px;
        border:1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        text-decoration:none; font-weight:700;
      }
      .btnx:hover{ transform: translateY(-1px); }
      .primary{ background: rgba(233,144,44,.18); border-color: rgba(233,144,44,.30); }
      .small { font-size: 13px; opacity:.85; }
      .kvs { display:grid; grid-template-columns: 180px 1fr; gap: 10px 14px; }
      @media (max-width: 640px){ .kvs{ grid-template-columns: 1fr; } }
      .hr { height:1px; background: rgba(255,255,255,.10); border:0; margin: 14px 0; }
      .score { font-size: 34px; font-weight: 900; }
      .muted { opacity: .7; }
      .notice{ border-color: rgba(255,200,0,.35); background: rgba(255,200,0,.06); }
      .footer { margin-top: 18px; opacity: .7; font-size: 12px; }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1 class="h1"><span class="iconwrap"><img class="icon icon--lg icon-verified" src="${BASE}icons/shield.svg" alt="" /> Verify Capitoken</span></h1>
      <p class="sub">Single source of truth for official domain, contract and links. If anything disagrees with this page, treat it as <b>not official</b>.</p>

      <!-- Mirror banner -->
      <div id="mirrorBanner" class="cardx notice" style="display:none;">
        <div class="row">
          <div>
            <div style="font-weight:900;">⚠ Mirror detected</div>
            <div class="small" id="mirrorText"></div>
          </div>
          <div class="btns">
            <a class="btnx primary" href="https://www.capitoken.org/verify" target="_blank" rel="noreferrer">Open Official /verify</a>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:14px;">
        <!-- Status / Score -->
        <div class="cardx" style="grid-column: span 12;">
          <div class="row">
            <div>
              <div class="tag" id="domainTag">Checking domain…</div>
              <div class="tag" id="etherscanTag" style="margin-left:8px;">Checking verification…</div>
            </div>
            <div>
              <span class="muted">Trust Score</span>
              <span class="score" id="trustScore">—</span>
            </div>
          </div>
          <hr class="hr" />
          <div class="kvs">
            <div class="muted">Official Domain</div>
            <div><a id="officialDomainLink" href="#" target="_blank" rel="noreferrer">—</a></div>

            <div class="muted">Network</div>
            <div id="networkName">—</div>

            

            <div class="muted">DEX Pair</div>
            <div><span class="mono" id="pairAddr">—</span> <span class="muted" id="pairDex" style="margin-left:8px;"> </span></div>

<div class="muted">Token</div>
            <div><span id="tokenName">—</span> (<span id="tokenSymbol">—</span>) · Decimals: <span id="tokenDecimals">—</span></div>
          </div>
        </div>

        <!-- Contract -->
        <div class="cardx" style="grid-column: span 12;">
          <div class="row">
            <div>
              <div style="font-weight:900;">Official Contract</div>
              <div class="mono" id="contractAddr">—</div>
            </div>
            <div class="btns">
              <button class="btnx" id="copyContract" type="button">Copy</button>
              <a class="btnx primary" id="openEtherscan" target="_blank" rel="noreferrer">Open Etherscan</a>
              <a class="btnx" id="addTokenHint" target="_blank" rel="noreferrer" href="https://support.metamask.io/manage-crypto/tokens/how-to-display-tokens-in-metamask/">How to add token</a>
            </div>
          </div>

          <div class="footer">
            Security rule: if the contract differs from <span class="mono">0xF2dA6C9B945c688A52D3B72340E622014920de6a</span> → NOT official.
          </div>
        </div>

        <!-- Official Links -->
        <div class="cardx" style="grid-column: span 12;">
          <div style="font-weight:900;">Official Links</div>
          <p class="small">Only these sources are considered official. Mirrors may exist, but the official domain remains <b>capitoken.org</b>.</p>
          <div class="kvs" style="margin-top:10px;">
            <div class="muted">Official Website</div>
            <div><a id="siteLink" target="_blank" rel="noreferrer">—</a></div>

            <div class="muted">GitHub (source)</div>
            <div><a id="repoLink" target="_blank" rel="noreferrer">—</a></div>

            <div class="muted">Etherscan Token</div>
            <div><a id="etherscanTokenLink" target="_blank" rel="noreferrer">—</a></div>

            <div class="muted">Buy (Uniswap)</div>
            <div><a id="buyLink" target="_blank" rel="noreferrer">—</a></div>

            <div class="muted">Live Market</div>
            <div><a id="marketLink" target="_blank" rel="noreferrer">—</a></div>


            <div class="muted">Mirror (GitHub Pages)</div>
            <div><a id="mirrorLink" target="_blank" rel="noreferrer">—</a></div>
          </div>
        </div>
      </div>
    </div>


    <!-- Toast (shared pattern with /) -->
    <div id="toast" class="toast" aria-live="polite" style="position:fixed;left:16px;bottom:16px;opacity:0;transform:translateY(8px);transition:all .2s;pointer-events:none;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.15);padding:10px 12px;border-radius:12px;font-size:.95rem;z-index:9999;"></div>
    <!-- ✅ FIX: define:vars para inyectar BASE y FALLBACK correctamente -->
    <script type="module" define:vars={{ BASE, FALLBACK }}>
      function scoreFrom(data, isOfficialHost) {
        let s = 0;
        if (data?.contract?.address) s += 35;
        if (data?.contract?.verified) s += 25;
        if (data?.contract?.token?.name && data?.contract?.token?.symbol) s += 10;
        if (data?.network?.chainId === 1) s += 10;
        if (isOfficialHost) s += 20;
        return Math.min(100, s);
      }

      function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = v ?? "—"; }
      function setHref(id, href, label){
        const el=document.getElementById(id);
        if(!el) return;
        el.href = href;
        el.textContent = label ?? href;
      }

      function toast(msg){
        const el = document.getElementById('toast');
        if(!el) return;
        el.textContent = msg;
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
        clearTimeout(window.__toastT);
        window.__toastT = setTimeout(()=>{
          el.style.opacity = '0';
          el.style.transform = 'translateY(8px)';
        }, 1800);
      }

      async function copyText(val){
        if(!val) return;
        try{
          await navigator.clipboard.writeText(val);
          toast('Copied');
          return true;
        }catch(e){
          try{
            const ta = document.createElement('textarea');
            ta.value = val;
            ta.setAttribute('readonly','');
            ta.style.position='absolute';
            ta.style.left='-9999px';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            ta.remove();
            toast('Copied');
            return true;
          }catch{
            toast('Copy failed');
            return false;
          }
        }
      }

      async function loadRegistry(){
        const url = BASE + "official-registry.json";
        try {
          const r = await fetch(url, { cache: "no-store" });
          if (!r.ok) throw new Error("registry fetch failed");
          return await r.json();
        } catch(e){
          return FALLBACK;
        }
      }

      (async function init(){
        const data = await loadRegistry();

        const host = window.location.hostname;
        const allowed = new Set((data.allowedDomains || []).map(x => String(x).toLowerCase()));
        const isOfficialHost = allowed.has(String(host).toLowerCase());

        // Mirror banner
        if (!isOfficialHost) {
          const b = document.getElementById("mirrorBanner");
          const t = document.getElementById("mirrorText");
          if (b) b.style.display = "block";
          if (t) t.textContent = data.security?.mirrorNotice || "You are viewing a mirror. The official site is https://www.capitoken.org";
        }

        // Tags
        const domainTag = document.getElementById("domainTag");
        if (domainTag) {
          domainTag.textContent = isOfficialHost ? "✔ Official domain" : "⚠ Mirror domain";
          domainTag.className = "tag " + (isOfficialHost ? "ok" : "warn");
        }

        const etherscanTag = document.getElementById("etherscanTag");
        if (etherscanTag) {
          etherscanTag.textContent = data.contract?.verified ? "✔ Etherscan verified" : "⚠ Not verified";
          etherscanTag.className = "tag " + (data.contract?.verified ? "ok" : "warn");
        }

        // Trust score
        const score = scoreFrom(data, isOfficialHost);
        setText("trustScore", String(score));

        // Core fields
        const officialUrl = "https://" + (data.officialDomain || "www.capitoken.org");
        setHref("officialDomainLink", officialUrl, officialUrl);

        setText("networkName", data.network?.name || "—");
        setText("tokenName", data.contract?.token?.name || "—");
        setText("tokenSymbol", data.contract?.token?.symbol || "—");
        setText("tokenDecimals", String(data.contract?.token?.decimals ?? "—"));

        const addr = data.contract?.address || "";
        setText("contractAddr", addr);

        const explorer = data.network?.explorer || "https://etherscan.io";
        const etherscanToken = addr ? `${explorer}/token/${addr}` : explorer;

        // Buttons / links
        const openE = document.getElementById("openEtherscan");
        if (openE) openE.href = etherscanToken;

        setHref("repoLink", data.officialRepo || "https://github.com/capitoken-org/capitoken-site");
        setHref("siteLink", "https://www.capitoken.org", "https://www.capitoken.org");
        setHref("etherscanTokenLink", etherscanToken, etherscanToken);

        // Mirror link (always show github pages)
        setHref("mirrorLink", "https://capitoken-org.github.io/capitoken-site/", "https://capitoken-org.github.io/capitoken-site/");
        // Copy contract
        const copyBtn = document.getElementById("copyContract");
        if (copyBtn) {
          copyBtn.addEventListener("click", async () => {
            copyBtn.textContent = "Copying…";
            const ok = await copyText(addr);
            copyBtn.textContent = "Copy";
            if (!ok) toast("Copy failed");
          });
        }
      })();
    </script>
  </body>
</html>
